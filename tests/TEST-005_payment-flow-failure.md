# TEST-005: 決済フロー統合テスト（失敗ケース）

**テストID**: TEST-005
**テスト種別**: 統合テスト（E2E - ネガティブテスト）
**所要時間**: 約15分
**前提条件**: TEST-004が正常にPASSしていること

---

## 1. テスト目的

決済が失敗した場合のエラーハンドリング、ユーザーへのフィードバック、データベースの整合性を確認する。

---

## 2. テスト環境

- **URL**: http://localhost/DayCare.app/welfare/
- **データベース**: daycare_welfare
- **Stripeモード**: テストモード

### Stripeテストカード（失敗パターン）

| カード番号 | 用途 | 期待される結果 |
|-----------|------|--------------|
| 4000 0000 0000 0002 | カード拒否 | 決済失敗エラー |
| 4000 0000 0000 9995 | 資金不足 | 決済失敗エラー |
| 4000 0000 0000 0069 | 期限切れカード | 決済失敗エラー |
| 4000 0000 0000 0127 | CVCエラー | 決済失敗エラー |

**参考**: [Stripe Testing Cards](https://stripe.com/docs/testing)

---

## 3. 事前準備

### 3.1 テストデータの準備

```sql
-- テスト前のデータ状態を記録
SELECT COUNT(*) AS before_count
FROM tbl_payment_history
WHERE company_id = 1;
```

この件数を記録しておく → **before_count**: ______

---

## 4. テスト手順

### テストケース1: カード拒否エラー

#### ステップ1: 料金プランページへ移動

1. ログイン後、`/company/payment` にアクセス

**期待結果**: ✅ Pricing Tableが表示される

---

#### ステップ2: プラン選択

1. 任意のプランを選択
2. Stripe Checkoutページへ遷移

**期待結果**: ✅ Checkoutページが表示される

---

#### ステップ3: 失敗するカード情報を入力

以下の情報を入力：

- **カード番号**: `4000 0000 0000 0002` （カード拒否）
- **有効期限**: `12/34`
- **CVC**: `123`
- **カード名義**: `Test Declined`
- **郵便番号**: `12345`

**期待結果**: ✅ 入力フィールドが有効化される

---

#### ステップ4: 決済実行

1. 「申し込む」ボタンをクリック

**期待結果**:
- ✅ Stripeがエラーメッセージを表示する
- ✅ エラーメッセージ: 「Your card was declined」または「カードが拒否されました」
- ✅ 決済が完了しない
- ✅ Checkoutページに留まる

**スクリーンショット**: `screenshots/test-005-case1-step4.png`

---

#### ステップ5: データベース確認

```sql
-- 決済履歴が増えていないことを確認
SELECT COUNT(*) AS after_count
FROM tbl_payment_history
WHERE company_id = 1;
```

**期待結果**:
- ✅ `after_count` == `before_count` （件数が増えていない）
- ✅ 失敗した決済のレコードは作成されない

```sql
-- 事業所のサブスクリプション状態が変わっていないことを確認
SELECT subscription_status, stripe_subscription_id
FROM tbl_company
WHERE company_id = 1;
```

**期待結果**:
- ✅ `subscription_status` が変更されていない（元の状態のまま）
- ✅ `stripe_subscription_id` が変更されていない

---

### テストケース2: 決済キャンセル

#### ステップ1: 料金プランページから再度プラン選択

1. `/company/payment` にアクセス
2. 任意のプランを選択
3. Stripe Checkoutページへ遷移

---

#### ステップ2: 決済をキャンセル

1. Checkoutページの左上にある「←」（戻る）ボタンをクリック
   - または、ブラウザの「戻る」ボタンをクリック

**期待結果**:
- ✅ `/company/payment-cancel` ページへリダイレクトされる
- ✅ キャンセルメッセージが表示される
- ✅ 「再試行」または「料金プランへ戻る」リンクが表示される

**スクリーンショット**: `screenshots/test-005-case2-step2.png`

---

#### ステップ3: データベース確認

```sql
-- 決済履歴が増えていないことを確認
SELECT COUNT(*) AS after_cancel_count
FROM tbl_payment_history
WHERE company_id = 1;
```

**期待結果**:
- ✅ `after_cancel_count` == `before_count`
- ✅ キャンセルした決済のレコードは作成されない

---

### テストケース3: 不正なセッションIDでアクセス

#### ステップ1: 不正なsession_idでアクセス

1. ブラウザで以下のURLに直接アクセス:
   ```
   http://localhost/DayCare.app/welfare/company/payment-success?session_id=cs_test_invalid123456
   ```

**期待結果**:
- ✅ エラーメッセージが表示される、または
- ✅ 決済情報が取得できない旨のメッセージが表示される
- ✅ システムがクラッシュしない

**スクリーンショット**: `screenshots/test-005-case3-step1.png`

---

### テストケース4: 資金不足エラー

#### ステップ1: 資金不足カードで決済

1. `/company/payment` にアクセス
2. プラン選択 → Checkout遷移
3. 以下の情報を入力:
   - **カード番号**: `4000 0000 0000 9995` （資金不足）
   - **有効期限**: `12/34`
   - **CVC**: `123`
   - その他: 任意
4. 「申し込む」ボタンをクリック

**期待結果**:
- ✅ エラーメッセージが表示される
- ✅ エラー内容: 「Insufficient funds」または「資金不足」
- ✅ 決済が完了しない

**スクリーンショット**: `screenshots/test-005-case4-step1.png`

---

### テストケース5: 期限切れカードエラー

#### ステップ1: 期限切れカードで決済

1. `/company/payment` にアクセス
2. プラン選択 → Checkout遷移
3. 以下の情報を入力:
   - **カード番号**: `4000 0000 0000 0069` （期限切れ）
   - **有効期限**: `12/34`
   - **CVC**: `123`
   - その他: 任意
4. 「申し込む」ボタンをクリック

**期待結果**:
- ✅ エラーメッセージが表示される
- ✅ エラー内容: 「Expired card」または「カードの有効期限切れ」
- ✅ 決済が完了しない

**スクリーンショット**: `screenshots/test-005-case5-step1.png`

---

## 5. エラーメッセージの確認

### 5.1 ユーザー向けエラー表示

以下のエラーが適切に表示されることを確認：

| エラー種別 | 表示されるべきメッセージ |
|-----------|----------------------|
| カード拒否 | カードが拒否されました。別のカードをお試しください。 |
| 資金不足 | 資金不足です。別のカードをお試しください。 |
| 期限切れ | カードの有効期限が切れています。 |
| CVC不一致 | セキュリティコードが正しくありません。 |

### 5.2 ログファイル確認

```bash
# Stripeログファイルを確認
cat C:\xampp\htdocs\DayCare.app\welfare\application\logs\stripe_YYYY-MM-DD.log
```

**期待結果**:
- ✅ エラーログが記録されている
- ✅ エラーの詳細（カード番号の末尾4桁、エラーコード等）が記録されている
- ✅ スタックトレースやデバッグ情報が記録されている（debug mode時）

---

## 6. テスト結果記録

### 6.1 テスト実施情報

| 項目 | 内容 |
|------|------|
| テスト実施日 | YYYY-MM-DD |
| テスト実施者 | [名前] |
| 実施環境 | ローカル開発環境 |
| 所要時間 | XX分 |

### 6.2 テスト結果サマリー

| テストケース | 結果 | 備考 |
|------------|------|------|
| ケース1: カード拒否エラー | ✅ PASS / ❌ FAIL |  |
| ケース2: 決済キャンセル | ✅ PASS / ❌ FAIL |  |
| ケース3: 不正なセッションID | ✅ PASS / ❌ FAIL |  |
| ケース4: 資金不足エラー | ✅ PASS / ❌ FAIL |  |
| ケース5: 期限切れカードエラー | ✅ PASS / ❌ FAIL |  |

### 6.3 総合判定

**判定**: ⭕ 合格 / ❌ 不合格

---

## 7. セキュリティチェック

### 7.1 エラー情報の漏洩チェック

エラーメッセージに以下の情報が**含まれていないこと**を確認：

- ❌ APIキー
- ❌ データベース接続情報
- ❌ ファイルパス
- ❌ スタックトレース（本番環境では非表示）
- ❌ 内部システムの詳細情報

**確認結果**: ⭕ OK / ❌ NG

### 7.2 CSRF保護の確認

1. ブラウザの開発者ツールでネットワークタブを開く
2. 決済フローを実行
3. POSTリクエストにCSRFトークンが含まれていることを確認

**確認結果**: ⭕ OK / ❌ NG

---

## 8. 不具合報告

### 不具合1

- **発生テストケース**:
- **現象**:
- **期待動作**:
- **再現手順**:
- **優先度**: High / Medium / Low

---

## 9. 備考・改善提案

-
-
-

---

## 10. 関連ドキュメント

- TEST-004: 決済フロー統合テスト（成功ケース）
- TEST-011: Webhook署名検証テスト
- TEST-013: XSS対策テスト
- [Stripe Testing Documentation](https://stripe.com/docs/testing)

---

**テスト手順書作成日**: 2025-10-03
**作成者**: Claude (AI Assistant)
**バージョン**: 1.0
